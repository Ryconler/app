<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è½¬ç›˜æŠ½å¥–</title>
    <link rel="stylesheet" href="../plugin/element/element.css">
    <link rel="stylesheet" href="../plugin/normalize/normalize.min.css">
    <link rel="stylesheet" href="./index.css">
    <script src="../plugin/vue/vue.js"></script>
    <script src="../plugin/element/element.js"></script>

    <style>
        .el-upload--picture-card,
        .el-upload-list__item {
            width: 80px !important;
            height: 80px !important;
            line-height: 80px !important;
        }
    </style>
</head>

<body>
    <div id="app">
        <div class="operate">
            <el-button type="danger" icon="el-icon-goods" circle @click="showDialog=true;"></el-button>
        </div>

        <div class="title">
            <img src="./img/lucky_title.png" alt="å¹¸è¿å¤§è½¬ç›˜">
        </div>

        <div class="wheel">
            <div class="wheel-main" :style="rotateStyle">
                <div class="prize-list">
                    <div class="prize-item" v-for="(item,index) in prizeList" :key="index" :style="item.style">
                        <img class="prize-pic" :src="item.icon" />
                        <div class="prize-name">{{item.name}}</div>
                    </div>
                </div>
            </div>
            <div class="wheel-pointer" @click="beginRotate()"></div>
        </div>

        <div class="toast-mask" v-show="currentPrize"></div>
        <div class="toast" v-show="currentPrize">
            <div class="toast-container">
                <img :src="toastIcon" class="toast-picture" />
                <div class="toast-close" @click="closeToast()"></div>
                <div class="toast-title">{{toastTitle}}</div>
                <div class="toast-btn">
                    <div class="toast-cancel" @click="closeToast">å…³é—­</div>
                </div>
            </div>
        </div>

        <el-dialog title="ä¿®æ”¹å¥–å“" :visible.sync="showDialog" width="80%">
            <el-row v-for="(item,index) in formData.prizes" :key="index" :gutter="20" style="margin-bottom:20px;">
                <h3>å¥–å“{{index+1}}</h3>
                <div style="display: flex;align-items: center;margin-bottom: 10px;">
                    <div style="width: 80px;">å¥–å“åç§°ï¼š</div>
                    <el-input v-model="item.name" size="mini" style="flex:1;" clearable></el-input>
                </div>
                <div style="display: flex;align-items: center;" v-if="item.fileList">
                    <span style="width: 80px;">å¥–å“å›¾ç‰‡ï¼š</span>
                    <el-upload action="#" :auto-upload="false" list-type="picture-card" :file-list="item.fileList" :on-change="file=>onFileChange(index,file)" :on-remove="file=>onFileRemove(index)">
                        <i class="el-icon-plus"></i>
                    </el-upload>
                </div>
            </el-row>
            <div slot="footer">
                <el-button size="mini" @click="showDialog = false">å– æ¶ˆ</el-button>
                <el-button size="mini" type="primary" @click="onConfirmClick">ç¡® å®š</el-button>
            </div>

        </el-dialog>
    </div>
</body>
<script>
    const config = {
        // æ€»æ—‹è½¬æ—¶é—´
        duration: 4000,
        // æ—‹è½¬åœˆæ•°
        circle: 8,
        prizeList: [{
            icon: "./img/bean_500.png", // å¥–å“å›¾ç‰‡
            name: "å…¶ä»–å¥–å“", // å¥–å“åç§°
            isPrize: true // è¯¥å¥–é¡¹æ˜¯å¦ä¸ºå¥–å“
        }, {
            icon: "./img/xiangyan.jpg",
            name: "é¦™çƒŸ",
            isPrize: true
        }, {
            icon: "./img/bean_500.png",
            name: "å…¶ä»–å¥–å“",
            isPrize: true
        }, {
            icon: "./img/chabei.jpg",
            name: "èŒ¶æ¯",
            isPrize: true
        }, {
            icon: "./img/bean_500.png",
            name: "å…¶ä»–å¥–å“",
            isPrize: true
        }, {
            icon: "./img/chaju.jpg",
            name: "èŒ¶å…·",
            isPrize: true
        }, {
            icon: "./img/bean_500.png",
            name: "å…¶ä»–å¥–å“",
            isPrize: true
        }, {
            icon: "./img/hongbao.jpg",
            name: "çº¢åŒ…ğŸ§§",
            isPrize: false
        }, ]
    }
    var app = new Vue({
        el: '#app',
        data: {
            count: 9999, // å‰©ä½™æŠ½å¥–æ¬¡æ•°
            prizeList: [], // å¥–å“åˆ—è¡¨
            angleList: [], // å¥–å“è§’åº¦
            rotateAngle: 0, // è½¬ç›˜æ—‹è½¬è§’åº¦
            currentPrize: null,
            isRotating: false,
            showDialog: false,
            formData: {
                prizes: [],
            }
        },
        computed: {
            rotateStyle() {
                return `
        -webkit-transition: transform ${config.duration}ms ease-in-out;
        transition: transform ${config.duration}ms ease-in-out;
        -webkit-transform: rotate(${this.rotateAngle}deg);
            transform: rotate(${this.rotateAngle}deg);`
            },
            toastTitle() {
                return this.currentPrize && this.currentPrize.isPrize ?
                    "æ­å–œæ‚¨ï¼Œè·å¾—" +
                    this.currentPrize.name :
                    "æœªä¸­å¥–";
            },
            toastIcon() {
                return this.currentPrize && this.currentPrize.isPrize ?
                    "./img/congratulation.png" :
                    "./img/sorry.png";
            }
        },
        created() {
            // è·å–å¥–å“åˆ—è¡¨
            this.getPrizeList();
            this.initAngleList();
            this.initFormData();
        },
        methods: {
            getPrizeList() {
                // è¿™é‡Œå¯ä»¥å‘èµ·è¯·æ±‚ï¼Œä»æœåŠ¡ç«¯è·å–å¥–å“åˆ—è¡¨
                // è¿™é‡Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
                const storagePrizeList = window.localStorage.getItem("prizeList");
                if (storagePrizeList) {
                    this.prizeList = JSON.parse(storagePrizeList);
                } else {
                    this.prizeList = config.prizeList;
                }
            },
            // æ ¼å¼åŒ–å¥–å“åˆ—è¡¨ï¼Œè®¡ç®—æ¯ä¸ªå¥–å“çš„ä½ç½®
            initAngleList() {
                // è®°å½•æ¯ä¸ªå¥–çš„ä½ç½®
                this.angleList = []

                const l = this.prizeList.length
                    // è®¡ç®—å•ä¸ªå¥–é¡¹æ‰€å çš„è§’åº¦
                const average = 360 / l

                const half = average / 2

                // å¾ªç¯è®¡ç®—ç»™æ¯ä¸ªå¥–é¡¹æ·»åŠ styleå±æ€§
                this.prizeList.forEach((item, i) => {
                    // æ¯ä¸ªå¥–é¡¹æ—‹è½¬çš„ä½ç½®ä¸º å½“å‰ i * å¹³å‡å€¼ + å¹³å‡å€¼ / 2
                    const angle = -((i * average) + half)
                        // å¢åŠ  style
                    item.style = `-webkit-transform: rotate(${angle}deg);
                      transform: rotate(${angle}deg);`

                    // è®°å½•æ¯ä¸ªå¥–é¡¹çš„è§’åº¦èŒƒå›´
                    this.angleList.push((i * average) + half)
                })
            },
            initFormData() {
                this.formData = {
                    prizes: []
                };

                this.prizeList.forEach((item, i) => {
                    this.formData.prizes.push({
                        name: item.name,
                        fileList: [{
                            url: item.icon
                        }]
                    });

                })
            },
            beginRotate() {
                // æ·»åŠ æ¬¡æ•°æ ¡éªŒ

                if (this.count === 0) return

                // å¼€å§‹æŠ½å¥–
                // è¿™é‡Œè¿™é‡Œå‘æœåŠ¡ç«¯å‘èµ·è¯·æ±‚ï¼Œå¾—åˆ°è¦è·å¾—çš„å¥–
                // å¯ä»¥è¿”å›ä¸‹æ ‡ï¼Œä¹Ÿå¯ä»¥è¿”å›å¥–å“ idï¼Œé€šè¿‡æŸ¥è¯¢ å¥–å“åˆ—è¡¨ï¼Œæœ€ç»ˆå¾—åˆ°ä¸‹æ ‡

                // éšæœºè·å–ä¸‹æ ‡
                const index = this.random(this.prizeList.length - 1);

                // å‡å°‘å‰©ä½™æŠ½å¥–æ¬¡æ•°
                this.count--;

                // å¼€å§‹æ—‹è½¬
                this.rotating(index)
            },
            random(max, min = 0) {
                return parseInt(Math.random() * (max - min + 1) + min)
            },
            rotating(index) {
                if (this.isRotating) return

                this.isRotating = true

                // è®¡ç®—è§’åº¦
                this.rotateAngle =
                    // åˆå§‹è§’åº¦
                    this.rotateAngle +
                    // å¤šæ—‹è½¬çš„åœˆæ•°
                    config.circle * 360 +
                    // å¥–é¡¹çš„è§’åº¦
                    this.angleList[index] -
                    (this.rotateAngle % 360);

                // æ—‹è½¬ç»“æŸåï¼Œå…è®¸å†æ¬¡è§¦å‘
                setTimeout(() => {
                    this.isRotating = false
                    this.currentPrize = this.prizeList[index]
                    console.log(this.currentPrize, index)
                }, config.duration + 500)
            },
            //å…³é—­å¼¹çª—
            closeToast() {
                this.currentPrize = null;
            },


            /* è¡¨å•éƒ¨åˆ† */
            onFileChange(index, file) {
                this.$set(this.formData.prizes[index], "fileList", [file]);
            },
            onFileRemove(index) {
                this.$set(this.formData.prizes[index], "fileList", []);
            },
            onConfirmClick() {
                const prizes = this.formData.prizes;
                const urls = [];
                for (let i = 0; i < 8; i++) {
                    urls.push(undefined);
                    if (prizes[i] && prizes[i].fileList[0]) {
                        this.file2DataUrl(prizes[i].fileList[0], url => {
                            urls[i] = url;
                        })
                    } else {
                        urls[i] = "./img/bean_500.png";
                    }
                }
                const t = setInterval(() => {
                    if (!urls.includes(undefined)) {
                        clearInterval(t);
                        const prizeList = [];
                        for (let i = 0; i < 8; i++) {
                            if (prizes[i] && prizes[i].name) {
                                prizeList.push({
                                    name: prizes[i].name,
                                    icon: urls[i],
                                    isPrize: true
                                });
                            } else {
                                prizeList.push({
                                    name: "è°¢è°¢å‚ä¸",
                                    icon: urls[i],
                                    isPrize: false
                                });
                            }
                        }
                        try{
                            window.localStorage.setItem("prizeList", JSON.stringify(prizeList));
                        }catch(e){
                            alert("å›¾ç‰‡å¤ªå¤§ï¼Œæ— æ³•æœ¬åœ°å­˜å‚¨ï¼Œè¯·æ›´æ¢å›¾ç‰‡");
                            return;
                        }
                        this.getPrizeList();
                        this.initAngleList();
                        this.showDialog = false
                    }
                }, 100)
            },
            file2DataUrl(fileObj, callback) {
                if (!fileObj) {
                    callback && callback("");
                } else if (fileObj.raw) {
                    try {
                        const fileReader = new FileReader();
                        fileReader.onload = function(e) {
                            callback && callback(e.target.result);
                        }
                        fileReader.readAsDataURL(fileObj.raw);
                    } catch (e) {
                        callback && callback(fileObj.url)
                        alert(e);
                    }
                } else {
                    callback && callback(fileObj.url)
                }
            },
        }
    })
</script>

</html>